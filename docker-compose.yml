#
# Copyright 2021 Alessandro De Blasis <alex@deblasis.net>
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
version: '3.6'

services:
  consul:
    image: consul:1.10.2
    environment: 
      NODE: consul  
      CONSUL_LOCAL_CONFIG: "{'skip_leave_on_interrupt': true}"
    command: consul agent -server -bind 0.0.0.0 -node consul -client 0.0.0.0 -dns-port 53 -data-dir /consul/data -ui -bootstrap  
# -advertise $PRIVATE_IP_ADDRESS \
    # volumes:
    #   - data_consul:/data
    networks:  
      net:

  # zipkin:
  #   image: openzipkin/zipkin
  #   ports:
  #     - 9411:9411
  #   networks:
  #     - net


  apigateway:
    image: deblasis/stc_apigateway:latest
    depends_on: 
      - consul
      - authsvc
    volumes:
      # - ./certs:/certs
      - ./services/apigateway/app.yaml:/app.yaml
    environment: 
     DEBLASIS_BINDONLOCALHOST: "false"
     DEBLASIS_SSL_SERVERCERT: /certs/deblasis-stc.pem
    #  DEBLASIS_SSL_SERVERKEY: /certs/deblasis-stc-key.pem
     DEBLASIS_APIGATEWAY_AUTHSERVICE_GRPCENDPOINT: deblasis-v1-AuthService.service.consul:9082
     DEBLASIS_APIGATEWAY_CENTRALCOMMANDSERVICE_GRPCENDPOINT: deblasis-v1-CentralCommandService.service.consul:9482
     DEBLASIS_APIGATEWAY_SHIPPINGSTATIONSERVICE_GRPCENDPOINT: deblasis-v1-ShippingStationService.service.consul:9282
    networks:
      net:
    dns:
      - 127.0.0.1
      - 8.8.8.8
      - 8.8.4.4      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      
  auth_db:
    image: postgres:13.4-alpine3.14
    command: ["postgres", "-c", "log_statement=all"]
    restart: always
    environment:
      PGUSER: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: auth
      DEBLASIS_CONSULT_HOST: consul
      DEBLASIS_CONSULT_PORT: 8500
      DEBLASIS_ZIPKINV2_URL: http://zipkin:9411/api/v2/spans

    networks: 
      - auth_backend    
      - net  
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 10s
      timeout: 5s
      retries: 5              


  auth_dbsvc:
    image: deblasis/stc_auth_dbsvc:latest
    depends_on: 
      - consul
      - auth_db
    volumes:
      # - ./certs:/certs
      - ./services/auth_dbsvc/app.yaml:/app.yaml
    environment: 
     DEBLASIS_BINDONLOCALHOST: "false"
     DEBLASIS_DB_ADDRESS: auth_db:5432
    #  DEBLASIS_SSL_SERVERCERT: /certs/deblasis-stc.pem
    #  DEBLASIS_SSL_SERVERKEY: /certs/deblasis-stc-key.pem
    networks:
      - net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9181/health"]
      interval: 30s
      timeout: 10s
      retries: 3      

  authsvc:
    image: deblasis/stc_authsvc:latest
    depends_on: 
      - consul
      - auth_dbsvc
    volumes:
      # - ./certs:/certs
      - ./services/authsvc/app.yaml:/app.yaml
      # - ./certs/jwt.pem.key:/certs/jwt.pem.key
      # - ./certs/jwt.pem.pub:/certs/jwt.pem.pub
    environment: 
     DEBLASIS_BINDONLOCALHOST: "false"
     DEBLASIS_SSL_SERVERCERT: /certs/deblasis-stc.pem
     DEBLASIS_SSL_SERVERKEY: /certs/deblasis-stc-key.pem
     DEBLASIS_JWT_PRIVKEYPATH: /certs/jwt.pem.key
     DEBLASIS_JWT_PUBKEYPATH: /certs/jwt.pem.pub
    networks:
      - net      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9081/health"]
      interval: 30s
      timeout: 10s
      retries: 3


  centralcommand_db:
    image: postgres:13.4-alpine3.14
    command: ["postgres"] # , "-c", "log_statement=all"]
    restart: always
    environment:
      PGUSER: postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: centralcommand
      DEBLASIS_CONSULT_HOST: consul
      DEBLASIS_CONSULT_PORT: 8500
      DEBLASIS_ZIPKINV2_URL: http://zipkin:9411/api/v2/spans
    networks: 
      - net  
    healthcheck:
      test: ["CMD-SHELL", "pg_isready"]
      interval: 10s
      timeout: 5s
      retries: 5             
      

  centralcommand_dbsvc:
    image: deblasis/stc_centralcommand_dbsvc:latest
    depends_on: 
      - consul
      - centralcommand_db
    volumes:
      # - ./certs:/certs
      - ./services/centralcommand_dbsvc/app.yaml:/app.yaml
    environment: 
      DEBLASIS_BINDONLOCALHOST: "false"
      DEBLASIS_DB_ADDRESS: centralcommand_db:5432
      # DEBLASIS_SSL_SERVERCERT: /certs/deblasis-stc.pem
      # DEBLASIS_SSL_SERVERKEY: /certs/deblasis-stc-key.pem
    networks:
      - net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9381/health"]
      interval: 30s
      timeout: 10s
      retries: 3         

  centralcommandsvc:
    image: deblasis/stc_centralcommandsvc:latest
    depends_on: 
      - consul
      - centralcommand_dbsvc
    volumes:
      # - ./certs:/certs
      - ./services/centralcommandsvc/app.yaml:/app.yaml
    environment: 
     DEBLASIS_BINDONLOCALHOST: "false"
     DEBLASIS_SSL_SERVERCERT: /certs/deblasis-stc.pem
    #  DEBLASIS_SSL_SERVERKEY: /certs/deblasis-stc-key.pem
    networks:
      - net      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9081/health"]
      interval: 30s
      timeout: 10s
      retries: 3        


  shippingstationsvc:
    image: deblasis/stc_shippingstationsvc:latest
    depends_on: 
      - consul
      - centralcommandsvc
    volumes:
      # - ./certs:/certs
      - ./services/shippingstationsvc/app.yaml:/app.yaml
    environment: 
     DEBLASIS_BINDONLOCALHOST: "false"
     DEBLASIS_SSL_SERVERCERT: /certs/deblasis-stc.pem
    #  DEBLASIS_SSL_SERVERKEY: /certs/deblasis-stc-key.pem
    networks:
      - net      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9081/health"]
      interval: 30s
      timeout: 10s
      retries: 3             

  clessidrasvc:
    image: deblasis/stc_clessidrasvc:latest
    depends_on: 
      - consul
      - centralcommand_dbsvc
    volumes:
      # - ./certs:/certs
      - ./services/clessidrasvc/app.yaml:/app.yaml
    environment: 
     DEBLASIS_CENTRALCOMMANDDB: centralcommand_db:5432
    networks:
      net:
    dns:
      - 127.0.0.1
      - 8.8.8.8
      - 8.8.4.4      
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9500/health"]
      interval: 30s
      timeout: 10s
      retries: 3  

networks: 
  #auth_frontend:    
  auth_backend:
  centralcommand_backend:
  net:
  ##  driver: bridge
