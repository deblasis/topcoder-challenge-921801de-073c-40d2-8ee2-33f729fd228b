name: E2E Tests
on: push
jobs:
  run_integration_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-go@v2
        with:
          go-version: '^1.17.1'  
      - name: Build, run, seed, e2e test
        run: |
          DOCKERCOMPOSE="docker-compose" COMPOSE_DOCKER_CLI_BUILD=1 DOCKER_BUILDKIT=1 make integrationtests-up \
          && make seed-auth_dbsvc \
          && sleep 15 \
          && docker ps \
          && COMPOSE_PROJECT_NAME=deblasis-stc-e2e_tests$(DOCKERCOMPOSE) -f docker-compose.yml -f docker-compose.ephemeral.yml exec -t apigateway bash -c 'while [[ "$$(curl --connect-timeout 2 -s -w ''%{http_code}'' ${APIGATEWAY:-http://localhost:8081}/health)" != "200" ]]; do echo ⏳ waiting for apigateway...; sleep 5; done; echo ✅ apigateway ready!;make dockertest' \
          && DOCKERCOMPOSE="docker-compose" make integrationtests-run
# - name: Seed initial user
#   run: make seed-auth_dbsvc
# - name: E2E Tests
#   run: DOCKERCOMPOSE="docker-compose" make integrationtests-run